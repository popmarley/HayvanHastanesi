@using Data
@inject ApplicationDbContext Db
@{
	var unreadCount = Db.Iletisims.Count(i => i.Okundu == "H");
}
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Yönetici Paneli</title>
	<!-- Favicon icon -->
	<link rel="icon" type="image/x-icon" href="~/content/assets/images/logo_icon.ico" />
	<link href="~/admin/css/style.css" rel="stylesheet">

</head>

<body>

	<!--*******************
		Preloader start
	********************-->
	<div id="preloader">
		<div class="sk-three-bounce">
			<div class="sk-child sk-bounce1"></div>
			<div class="sk-child sk-bounce2"></div>
			<div class="sk-child sk-bounce3"></div>
		</div>
	</div>
	<!--*******************
		Preloader end
	********************-->
	<!--**********************************
		Main wrapper start
	***********************************-->
	<div id="main-wrapper">

		<!--**********************************
			Nav header start
		***********************************-->
		<div class="nav-header">
			<a asp-controller="Admin" asp-action="Admin" class="brand-logo">
				<img class="logo-abbr" src="~/admin/images/logo.png" alt="">
				<img class="logo-compact" src="~/admin/images/logo-text.png" alt="">
				<img class="brand-title" src="~/admin/images/logo-text.png" alt="">
			</a>

			<div class="nav-control">
				<div class="hamburger">
					<span class="line"></span><span class="line"></span><span class="line"></span>
				</div>
			</div>
		</div>
		<!--**********************************
			Nav header end
		***********************************-->
		<!--**********************************
			Header start
		***********************************-->
		<div class="header">
			<div class="header-content">
				<nav class="navbar navbar-expand">
					<div class="collapse navbar-collapse justify-content-between">
						<div class="header-left">
							<div class="search_bar dropdown">
								<span class="search_icon p-3 c-pointer" data-toggle="dropdown">
									<i class="mdi mdi-magnify"></i>
								</span>
								<div class="dropdown-menu p-0 m-0">
									<form>
										<input class="form-control" type="search" placeholder="Ara..." aria-label="Ara...">
									</form>
								</div>
							</div>
						</div>

						<ul class="navbar-nav header-right">
							<li class="nav-item dropdown notification_dropdown">
								<a class="nav-link" href="#" role="button" data-toggle="dropdown">
									<i class="mdi mdi-bell"></i>
									<div class="pulse-css"></div>
								</a>
								<div class="dropdown-menu dropdown-menu-right">
									<ul class="list-unstyled">
										<li class="media dropdown-item">
											<span class="success"><i class="ti-user"></i></span>
											<div class="media-body">
												<a href="#">
													<p>
														<strong>Martin</strong> has added a <strong>customer</strong> Successfully
													</p>
												</a>
											</div>
											<span class="notify-time">14:20</span>
										</li>
									</ul>
									<a class="all-notification" href="#">
										Tüm Bildirimleri Gör <i class="ti-arrow-right"></i>
									</a>
								</div>
							</li>
							<li class="nav-item dropdown header-profile">
								<a class="nav-link d-flex align-items-center" href="#" role="button" data-toggle="dropdown">
									<i class="mdi mdi-account mr-2"></i>
									<span>@User.Identity.Name</span>
								</a>
								<div class="dropdown-menu dropdown-menu-right">
									<a href="#" class="dropdown-item">
										<i class="icon-user"></i>
										<span class="ml-2">Hesabım</span>
									</a>
									<a asp-controller="Admin" asp-action="Admin" class="dropdown-item">
										<i class="icon-envelope-open"></i>
										<span class="ml-2">Gelen Kutusu </span>
									</a>
									<a asp-controller="Giris" asp-action="Cikis" class="dropdown-item">
										<i class="icon-key"></i>
										<span class="ml-2">Çıkış Yap </span>
									</a>
								</div>
							</li>

						</ul>
					</div>
				</nav>
			</div>
		</div>
		<!--**********************************
			Header end ti-comment-alt
		***********************************-->
		<!--**********************************
			Sidebar start
		***********************************-->
		<div class="quixnav">
			<div class="quixnav-scroll">
				<ul class="metismenu" id="menu">
					<li>
						<a class="has-arrow" href="javascript:void()" aria-expanded="false">
							<i class="fa fa-envelope"></i><span class="nav-text">Mail</span>
						</a>
						<ul aria-expanded="false">
							<li>
								<a asp-controller="Admin" asp-action="Admin">
									<i class="fa fa-inbox"></i>
									Gelen Kutusu
								</a>
							</li>
						</ul>
					</li>

					<li>
						<a class="has-arrow" href="javascript:void()" aria-expanded="false">
							<i class="icon icon-app-store"></i><span class="nav-text">Uygulamalar</span>
						</a>
						<ul aria-expanded="false">
							<li><a href="./app-profile.html"><i class="fa fa-user"></i> Kullanıcılar</a></li>
						</ul>
					</li>
				</ul>
			</div>
		</div>
		<!--**********************************
			Sidebar end
		***********************************-->
		<!--**********************************
			Content body start
		***********************************-->
		<div class="content-body">
			<div class="container-fluid">
				<!-- row -->
				<div class="row">
					<div class="col-lg-12">
						<div class="card">
							<div class="card-body">
								<div class="email-left-box px-0 mb-5">
									<div class="mail-list mt-4">
										<a asp-controller="Admin" asp-action="Admin" class="list-group-item active">
											<i class="fa fa-inbox font-18 align-middle mr-2"></i>
											Gelen Kutusu
											<span class="badge badge-danger text-white badge-sm float-right">@unreadCount</span>
										</a>
@* 
										<a href="javascript:void()" class="list-group-item">
											<i class="fa fa-star font-18 align-middle mr-2"></i>Yıldızlı <span class="badge badge-danger text-white badge-sm float-right">47</span>
										</a>
										<a href="javascript:void()" class="list-group-item">
											<i class="fa fa-trash font-18 align-middle mr-2"></i>Çöp Kutusu
										</a> *@
									</div>
								</div>
								@RenderBody()
							</div>
						</div>
					</div>
				</div>
			
			</div>
			<!--**********************************
				Content body end
			***********************************-->
			<!--**********************************
				Footer start
			***********************************-->
			

			<!--**********************************
				Footer end
			***********************************-->
			<!--**********************************
			   Support ticket button start
			***********************************-->
			<!--**********************************
			   Support ticket button end
			***********************************-->


		</div>
		<div class="footer">
			<div class="version">Version 1.0 (is Derlemesi 250723,1223)</div>
			<div class="copyright">
				<p>
					Copyright ©
					<script>document.write(new Date().getFullYear())</script>
					<a href="https://github.com/popmarley" target="_blank">Pop Marley</a>
				</p>
			</div>
		</div>
		<!--**********************************
			Main wrapper end
		***********************************-->
		<!--**********************************
			Scripts
		***********************************-->
		<!-- Required vendors -->
		<script src="~/admin/vendor/global/global.min.js"></script>
		<script src="~/admin/js/quixnav-init.js"></script>
		<script src="~/admin/js/custom.min.js"></script>




</body>
<script>
	(function () {
	  const BASE_TITLE = document.title;
	  const POLL_MS = 8000;
	  const trMonths = ["Oca","Şub","Mar","Nis","May","Haz","Tem","Ağu","Eyl","Eki","Kas","Ara"];

	  // Bildirim sesi (dosyayı wwwroot/sounds/notify.mp3 olarak koy)
	  const audio = window._mailNotifyAudio || new Audio('@Url.Content("~/sounds/notify.mp3")');
	  audio.preload = 'auto';
	  window._mailNotifyAudio = audio;

	  // Kullanıcı en az bir kez tıklamadan bazı tarayıcılar sesi engeller
	  let soundEnabled = localStorage.getItem('mail:soundEnabled') === '1';
	  if (!soundEnabled) {
		window.addEventListener('click', () => {
		  soundEnabled = true;
		  localStorage.setItem('mail:soundEnabled', '1');
		}, { once: true });
	  }

	  // Sayfalar arası lastId
	  let lastId = Number(localStorage.getItem('mail:lastId') || 0);
	  let firstPoll = true;

	  function updateTitle(unread) {
		document.title = (unread > 0) ? `(${unread}) ${BASE_TITLE}` : BASE_TITLE;
	  }

	  function playDing() {
		if (!soundEnabled) return;
		audio.currentTime = 0;
		audio.play().catch(() => {});
	  }

	  function escapeHtml(str) {
		if (str == null) return '';
		const p = document.createElement('p');
		p.appendChild(document.createTextNode(str));
		return p.innerHTML;
	  }

	  function parseDate(val) {
		if (!val) return null;
		// /Date(1691577600000)/ desteği
		if (typeof val === 'string' && val.indexOf('/Date(') === 0) {
		  const ms = parseInt(val.replace(/[^0-9]/g, ''), 10);
		  return new Date(ms);
		}
		return new Date(val);
	  }

	  function formatDisplayTime(val) {
		const d = parseDate(val);
		if (!d || isNaN(d.getTime())) return '';
		const now = new Date();
		const sameDay = d.getFullYear()===now.getFullYear()
		  && d.getMonth()===now.getMonth()
		  && d.getDate()===now.getDate();
		return sameDay
		  ? d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
		  : `${d.getDate()} ${trMonths[d.getMonth()]}`;
	  }

	  function renderToList(item) {
		// Bu sayfada liste yoksa sadece ses+başlık
		const list = document.querySelector('.email-list');
		if (!list) return;

		const id = Number(item.iletisimID);
		const href = '@Url.Action("EmailRead", "Admin")' + `?id=${id}`;
		const unreadClass = item.okundu === 'H' ? 'unread' : '';
		const msg = item.mesaj || '';
		const preview = msg.length > 150 ? msg.substring(0,150) + '…' : msg;
		const timeStr = formatDisplayTime(item.olusturmaTarihi);

		const html = `
		  <div class="message ${unreadClass}">
			<div>
			  <div class="d-flex message-single">
				<div class="custom-control custom-checkbox pl-4">
				  <input type="checkbox" />
				</div>
				<div class="ml-2">
				  <button class="border-0 bg-transparent align-middle p-0">
					<i class="fa fa-star" aria-hidden="true"></i>
				  </button>
				</div>
			  </div>
			  <a href="${href}" class="col-mail col-mail-2">
				<div class="subject">${escapeHtml(preview)}</div>
				<div class="date">${escapeHtml(timeStr)}</div>
			  </a>
			</div>
		  </div>`;
		list.insertAdjacentHTML('afterbegin', html);
	  }

	  async function initMeta() {
		if (lastId > 0) return;
		try {
		  const r = await fetch('@Url.Action("MailMeta", "Admin")', { headers: { 'Accept':'application/json' }});
		  if (!r.ok) return;
		  const m = await r.json();
		  if (m.lastId) {
			lastId = Number(m.lastId);
			localStorage.setItem('mail:lastId', String(lastId));
		  }
		  if (typeof m.unreadCount === 'number') updateTitle(m.unreadCount);
		} catch {}
	  }

	  async function poll() {
		try {
		  const r = await fetch('@Url.Action("CheckMail", "Admin")' + `?afterId=${lastId}`, {
			headers: { 'Accept':'application/json' }
		  });
		  if (!r.ok) return;
		  const data = await r.json();

		  let hasNew = false;
		  if (Array.isArray(data.newItems) && data.newItems.length) {
			data.newItems.forEach(it => {
			  const id = Number(it.iletisimID || 0);
			  if (id > lastId) lastId = id;
			  renderToList(it);
			});
			localStorage.setItem('mail:lastId', String(lastId));
			hasNew = true;
		  }

		  if (typeof data.unreadCount === 'number') updateTitle(data.unreadCount);
		  if (!firstPoll && hasNew) playDing();
		  firstPoll = false;
		} catch {}
	  }

	  // Başlat
	  initMeta().then(() => {
		poll();
		setInterval(poll, POLL_MS);
		window.addEventListener('focus', poll);
	  });
	})();
</script>

</html>

